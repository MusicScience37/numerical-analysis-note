% !TEX root = ../main.tex
%

\chapter{Runge-Kutta 法}

Runge-Kutta 法 (Runge-Kutta method) では次のような形式の初期値問題を数値的に解く
\cite{Mitsui1993}．
\begin{equation}
    \begin{cases}
        \dot{\bm{y}} = \bm{f}(t, \bm{y}) \\
        \bm{y}(0) = \bm{y}_0
    \end{cases}
\end{equation}

Runge-Kutta 法は，時刻 $t$ における変数 $\bm{y}(t)$ の値から，
次のような形式で時刻 $t + h$ における変数 $\bm{y}(t + h)$ の計算を行う．
\begin{align}
    \bm{k}_i      & = \bm{f}\left(t + b_i h, \bm{y}(t) + h \sum_{j = 1}^s a_{ij} \bm{k}_j \right)
                  & \text{for $i = 1, 2, \ldots, s$}
    \label{eq:ode_runge-kutta_k-law}                                                              \\
    \bm{y}(t + h) & = \bm{y}(t) + \sum_{i=1}^s c_i \bm{k}_i
    \label{eq:ode_runge-kutta_y-law}
\end{align}

ここで，時間の更新幅 $h$ はステップ幅と呼ばれる．
Runge-Kutta 法には，
整数 $s$ （段数と呼ばれる）と係数 $a_{ij}$, $b_i$, $c_i$ の異なる様々な公式が存在する．
係数 $a_{ij}$, $b_i$, $c_i$ は
表 \ref{table:ode_runge-kutta_butcher-array-general} のような
Butcher 配列と呼ばれる形式で記載される．

\begin{table}[bp]
    \caption{Butcher 配列における係数の並べ方}
    \label{table:ode_runge-kutta_butcher-array-general}
    \centering
    \begin{tabular}{c|ccccc}
        $b_1$    & $a_{11}$ & $a_{12}$ & $a_{13}$ & $\cdots$ & $a_{1s}$ \\
        $b_2$    & $a_{21}$ & $a_{22}$ & $a_{23}$ & $\cdots$ & $a_{2s}$ \\
        $b_3$    & $a_{31}$ & $a_{32}$ & $a_{33}$ & $\cdots$ & $a_{3s}$ \\
        $\vdots$ & $\vdots$ & $\vdots$ & $\vdots$ & $\ddots$ & $\vdots$ \\
        $b_s$    & $a_{s1}$ & $a_{s2}$ & $a_{s3}$ & $\cdots$ & $a_{ss}$ \\
        \hline
                 & $c_1$    & $c_2$    & $c_3$    & $\cdots$ & $c_s$
    \end{tabular}
\end{table}

Runge-Kutta 法の公式は次のように分類される．

\begin{description}
    \item[陽的 Runge-Kutta 法] $j \ge i$ について $a_{ij} = 0$ となっている場合，
          $\bm{k}i$ は $\bm{k}_1, \bm{k}_2, \ldots, \bm{k}_s$
          の順に式 \eqref{eq:ode_runge-kutta_k-law} の右辺を評価することで計算できる．
          このような場合は陽的 Runge-Kutta 法と呼ばれる．
    \item[半陰的 Runge-Kutta 法] $j > i$ について $a_{ij} = 0$ となっている場合，
          $\bm{k}i$ は $\bm{k}_1, \bm{k}_2, \ldots, \bm{k}_s$
          の順に式 \eqref{eq:ode_runge-kutta_k-law} を $\bm{k}_i$ について解くことで計算できる．
          このような場合は半陰的 Runge-Kutta 法と呼ばれる．
    \item[陰的 Runge-Kutta 法] $j > i$ でも $a_{ij} \neq 0$ となる係数が存在する場合，
          $\bm{k}i$ は $i = 1, 2, \ldots, s$ について連立した
          式 \eqref{eq:ode_runge-kutta_k-law} を $\bm{k}_i$ について解くことで計算する．
          このような場合は陰的 Runge-Kutta 法と呼ばれる．
\end{description}

陽的 Runge-Kutta 法の方が計算は単純だが，
陰的 Runge-Kutta 法は

\begin{itemize}
    \item 硬い系と呼ばれる比較的不安定な微分方程式で解が安定しやすい．
    \item 陽的 Runge-Kutta 法よりも少ない段数でより高い次数を出せる．
          （後述する公式の実例を見ると分かる．）
\end{itemize}

といった利点を持つ．
そのため，解が安定するようにステップ幅を調整した場合，
陰的 Runge-Kutta 法の方がステップ幅を大きくとることができ，
目的の時刻 $t$ までの解を得るために必要な計算時間は少なくなる場合がある．

また，Runge-Kutta 法の公式の精度を示す数値として次数が存在する．
変数の近似値 $\bm{y}(t + h)$ の精度が $h^p$ オーダーの場合，
その公式は $p$ 次といい，$p$ は次数と呼ばれる．

\section{埋め込み型公式}

Runge-Kutta 法の公式の中には，複数の $b_i$ の組を持つものがある
（表 \ref{table:ode_runge-kutta_butcher-array-rkf45} の例を参照）．
そのような公式では，次のような 2 つの近似値を得ることができる．
\begin{align}
    \bm{y}(t + h)   & = \bm{y}(t) + \sum_{i=1}^s c_i \bm{k}_i     \\
    \bm{y}^*(t + h) & = \bm{y}^*(t) + \sum_{i=1}^s c_i^* \bm{k}_i
\end{align}
これらの差により誤差の近似値を求めることができる．
\begin{align}
    \bm{y}(t + h) - \bm{y}^*(t + h) & = \sum_{i=1}^s (c_i - c_i^*) \bm{k}_i
\end{align}

これを用いると，現在のステップ幅から次のステップ幅 $\hat{h}$ の適正値を推定できる．
まず，$b_i$ と $b_i^*$ のうち次数が低い方の次数を $p$ とすると，
\begin{align}
    \left| \bm{y}(t + h) - \bm{y}^*(t + h) \right| \approx |Ah^p|
\end{align}
のように書ける．
そこで，誤差の許容量を $\epsilon_{tol}$ としたとき，次の方程式が成り立つようにする．
\begin{equation}
    \frac{\hat{h}^p}{h^p} = \frac{\epsilon_{tol}}{\left| \bm{y}(t + h) - \bm{y}^*(t + h) \right|}
\end{equation}
これを $\hat{h}$ について解くと，次のようになる．
\begin{equation}
    \hat{h} = h \left(\frac{\epsilon_{tol}}{\left| \bm{y}(t + h) - \bm{y}^*(t + h) \right|}\right)^{\frac{1}{p}}
\end{equation}

\section{陰的 Runge-Kutta 法における方程式の解法}

陰的 Runge-Kutta 法においては，
式 \eqref{eq:ode_runge-kutta_k-law} を方程式として解く必要がある．
数値解法に頼りたくなるような状況下において関数 $\bm{f}$ は非線形であるため
\footnote{関数 $\bm{f}$ が線形な場合，行列の指数関数による一般解が存在し，%
    固有値分解により簡単に解を得ることが可能であるため，%
    あえて Runge-Kutta 法を使用する必要はない．}，
Newton-Raphson 法（\ref{chap:root-finding_newton-raphson} 章）のような
非線形方程式の数値解法を用いる必要がある．

\subsection{半陰的公式の場合}

半陰的公式の場合，$i = 1, 2, \ldots, s$ のそれぞれについて以下の方程式を解く必要がある．
\begin{equation}
    \bm{F}_i(\bm{k}_i)
    \equiv \bm{k}_i - \bm{f}\left(t + b_i h, \bm{y}(t) + h \sum_{j = 1}^i a_{ij} \bm{k}_j \right)
    = \bm{0}
\end{equation}

この方程式の数値解法として
Newton-Raphson 法を用いる場合，Jacobian
\begin{equation}
    \left. \frac{\partial \bm{F}_i}{\partial \bm{k}_i} \right|_{\bm{k}_i = \bm{k}_i}
    = I - h a_{ii}
    \left. \frac{\partial \bm{f}}{\partial \bm{y}}
    \right|_{t = t + b_i h, \bm{y} = \bm{y}(t) + h \sum_{j = 1}^i a_{ij} \bm{k}_j}
\end{equation}
を使用する必要がある．
Newton-Raphson 法における更新式は次のようになる．
\begin{equation}
    (\bm{k}_i)_{n+1} = (\bm{k}_i)_{n}
    - \left(\left. \frac{\partial \bm{F}_i}{\partial \bm{k}_i} \right|_{\bm{k}_i = \bm{k}_i}\right)^{-1}
    \bm{F}_i(\bm{k}_i)
\end{equation}
Newton-Raphson 法の各反復ごとに更新された Jacobian の LU 分解を求める必要がある．

ステップ幅を十分小さくとっている場合，
Jacobian の $\bm{k}_i$ に応じた変化量は少ないため，
Jacobian を $\bm{k}_i = \bm{0}$ のときの
\begin{equation}
    J \equiv I - h a_{ii}
    \left. \frac{\partial \bm{f}}{\partial \bm{y}}
    \right|_{t = t + b_i h, \bm{y} = \bm{y}(t)}
\end{equation}
に固定するという近似もあり得る
\cite[6.2 節 (c)]{Mitsui1993}．
この場合，1 段に 1 回だけ Jacobian とその LU 分解を計算すれば良い
\footnote{$d$ 次元の LU 分解において，係数行列が更新された場合は $d^3$ オーダーの時間がかかり，%
    係数行列が変わらず適応先のベクトルのみが更新された場合は $d^2$ オーダーの時間で済む．%
    対象とする常微分方程式の自由度の数が多いほど効果が大きくなる．}．

\subsection{陰的公式の場合}

半陰的公式でなく陰的公式の場合，
必要な方程式は次元が増えた次のようなものになる．
\begin{equation}
    \bm{F}_i(\bm{k}_i)
    \equiv
    \begin{pmatrix}
        \bm{k}_1 - \bm{f}\left(t + b_1 h, \bm{y}(t) + h \sum_{j = 1}^s a_{1j} \bm{k}_j \right) \\
        \bm{k}_2 - \bm{f}\left(t + b_2 h, \bm{y}(t) + h \sum_{j = 1}^s a_{2j} \bm{k}_j \right) \\
        \vdots                                                                                 \\
        \bm{k}_s - \bm{f}\left(t + b_s h, \bm{y}(t) + h \sum_{j = 1}^s a_{sj} \bm{k}_j \right) \\
    \end{pmatrix}
    = \bm{0}
\end{equation}

Jacobian は次のようになる．
\begin{align}
    \left. \frac{\partial \bm{F}_i}{\partial (\bm{k}_1, \bm{k}_2, \ldots, \bm{k}_s)}
    \right|_{\bm{k}_i = \bm{k}_i}
    = I -
    \begin{pmatrix}
        J_{11} & J_{12} & \cdots & J_{1s} \\
        J_{21} & J_{22} & \cdots & J_{2s} \\
        \vdots & \vdots & \ddots & \vdots \\
        J_{s1} & J_{s2} & \cdots & J_{ss}
    \end{pmatrix}
    \\
    J_{ij} = h a_{ij} \left. \frac{\partial \bm{f}}{\partial \bm{y}}
    \right|_{t = t + c_i h, \bm{y} = \bm{y}(t) + h \sum_{l = 1}^i a_{il} \bm{k}_l}
\end{align}

半陰的公式と同様に，
上記の Jacobian を $\bm{k}_i = \bm{0}$ のときのものに固定することで
計算時間を減らすことが考えられる．
陰的公式では Jacobian のサイズが大きくなるため，
Jacobian を固定することの効果はより大きくなる
\footnote{$d$ 次元の常微分方程式に対して $s$ 段公式を使用すると，%
    Jacobian は $ds$ 次元の正方行列となる．}．

\section{陽的公式の例}

\subsection{古典的 Runge-Kutta 法}

\begin{table}[bp]
    \caption{古典的 Runge-Kutta 法 （RK4 公式）の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-rk4}
    \centering
    \begin{tabular}{c|cccc}
        $0$           &               &               &               &               \\
        $\frac{1}{2}$ & $\frac{1}{2}$ &               &               &               \\
        $\frac{1}{2}$ & $0$           & $\frac{1}{2}$ &               &               \\
        $1$           & $0$           & $0$           & $1$           &               \\
        \hline
                      & $\frac{1}{6}$ & $\frac{1}{3}$ & $\frac{1}{3}$ & $\frac{1}{6}$
    \end{tabular}
\end{table}

古典的 Runge-Kutta 法と呼ばれる公式では，
表 \ref{table:ode_runge-kutta_butcher-array-rk4} のような係数を用いる
\cite[3.3 節]{Mitsui1993}．
単純な係数で次数 4 を達成できる．

\subsection{RKF45 公式}

\begin{table}[bp]
    \caption{RKF45 公式の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-rkf45}
    \centering
    \begin{tabular}{c|ccccccc}
        $0$             &                     &                      &                      &                       &                  &                &          \\
        $\frac{1}{4}$   & $\frac{1}{4}$       &                      &                      &                       &                  &                &          \\
        $\frac{3}{8}$   & $\frac{3}{32}$      & $\frac{9}{32}$       &                      &                       &                  &                &          \\
        $\frac{12}{13}$ & $\frac{1932}{2197}$ & $-\frac{7200}{2197}$ & $\frac{7296}{2197}$  &                       &                  &                &          \\
        $1$             & $\frac{439}{216}$   & $-8$                 & $\frac{3680}{513}$   & $-\frac{845}{4104}$   &                  &                &          \\
        $\frac{1}{2}$   & $-\frac{8}{27}$     & $2$                  & $-\frac{3544}{2565}$ & $\frac{1859}{4104}$   & $-\frac{11}{40}$ &                &          \\
        \hline
                        & $\frac{16}{135}$    & $0$                  & $\frac{6656}{12825}$ & $\frac{28561}{56430}$ & $-\frac{9}{50}$  & $\frac{2}{55}$ & （5 次） \\
                        & $\frac{25}{216}$    & $0$                  & $\frac{1408}{2565}$  & $\frac{2197}{4104}$   & $-\frac{1}{5}$   & $0$            & （4 次）
    \end{tabular}
\end{table}

RKF45 公式（RKF は Runge-Kutta-Fehlberg のこと）では，
表 \ref{table:ode_runge-kutta_butcher-array-rkf45} のような係数を用いる
\cite[4.1 節 (a)]{Mitsui1993}, \cite[Section 9.5]{Mathews2004}．
この埋め込み型公式では，$\bm{k}_i$ から $\bm{y}(t + h)$ を算出する係数に
5 次の精度を持つ組と 4 次の精度を持つ組が存在する
\footnote{挙げた 2 件の文献のうち，%
    文献 \cite{Mitsui1993} では係数が一カ所誤っていたため注意が必要．}．

\subsection{Euler 法}

\begin{table}[bp]
    \caption{Euler 法の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-explicit-euler}
    \centering
    \begin{tabular}{c|c}
        $1$ &     \\
        \hline
            & $1$
    \end{tabular}
\end{table}

常微分方程式の解法としては最も基本的な Euler 法は形式的に Runge-Kutta 法とみなすことができる．
Euler 法は
\begin{equation}
    \bm{y}(t + h) \approx \bm{y}(t) + h \bm{f}(t, \bm{y}(t))
\end{equation}
のように書かれるが，
その Butcher 配列は表 \ref{table:ode_runge-kutta_butcher-array-explicit-euler} に示す通りである．

\section{半陰的公式の例}

\subsection{田中 Formula}

\begin{table}[bp]
    \caption{田中 Formula1 公式の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-tanaka-formula1}
    \centering
    \begin{tabular}{c|ccc}
        $\frac{13}{20}$ & $\frac{13}{20}$    &                  &          \\
        $-\frac{1}{18}$ & $-\frac{127}{180}$ & $\frac{13}{20}$  &          \\
        \hline
                        & $\frac{100}{127}$  & $\frac{27}{127}$ & （3 次） \\
                        & $1$                &                  & （1 次）
    \end{tabular}
\end{table}

\begin{table}[bp]
    \caption{田中 Formula2 公式の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-tanaka-formula2}
    \centering
    \begin{tabular}{c|cccc}
        $\frac{133}{100}$ & $\frac{133}{100}$     &                       &                      &          \\
        $\frac{1}{2}$     & $-\frac{5400}{18167}$ & $\frac{28967}{36334}$ &                      &          \\
        $-\frac{33}{100}$ & $\frac{133}{50}$      & $-\frac{108}{25}$     & $\frac{133}{100}$    &          \\
        \hline
                          & $\frac{1250}{20667}$  & $\frac{18167}{20667}$ & $\frac{1250}{20667}$ & （4 次） \\
                          & $0$                   & $1$                   &                      & （2 次）
    \end{tabular}
\end{table}

文献 \cite{Togawa2007} では，田中正次氏が考案した半陰的・陰的公式がいくつか示されている．
そのうち埋め込み型の半陰的公式を表
\ref{table:ode_runge-kutta_butcher-array-tanaka-formula1},
\ref{table:ode_runge-kutta_butcher-array-tanaka-formula2}
に示す
\footnote{文献 \cite{Togawa2007} には完全に陰的な 4 段 7 次の公式もあるが，%
    係数がかなり複雑なため省略した．}．

段数の多い陽的公式と同程度の精度を少ない段数で出すことができていることを確認できる．
また，埋め込み型の 2 つの係数のうち次数の低い方の係数が単純になっている
\footnote{利用する際には高い次数の係数との差を見るように実装するため，%
    次数の低い方の係数だけ単純でも計算コストへの影響はない．}．

\section{陰的公式の例}

\subsection{Butcher-Kuntzmann 公式}

\begin{table}[bp]
    \caption{2 段 Butcher-Kuntzmann 公式の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-2stage-butcher-kuntzmann}
    \centering
    \begin{tabular}{c|cc}
        $\frac{1}{2} + \frac{\sqrt{3}}{6}$ & $\frac{1}{4}$                      & $\frac{1}{4} + \frac{\sqrt{3}}{6}$ \\
        $\frac{1}{2} - \frac{\sqrt{3}}{6}$ & $\frac{1}{4} - \frac{\sqrt{3}}{6}$ & $\frac{1}{4}$                      \\
        \hline
                                           & $\frac{1}{2}$                      & $\frac{1}{2}$
    \end{tabular}
\end{table}

文献 \cite[5.2 節 (b)]{Mitsui1993} によると，
陰的 Runge-Kutta 法では，$s$ 段公式で $2s$ 次を超えることができないと証明されており，
その限界の $2s$ 次の公式が存在することも証明されている．
特に Legendre 関数の零点を用いて係数を決める種類の公式は，
$s$ 段 Butcher-Kuntzmann 公式と呼ばれる．
2 段 Butcher-Kuntzmann 公式を表
\ref{table:ode_runge-kutta_butcher-array-2stage-butcher-kuntzmann}
に示す（前述の通り 4 次の精度を持つ）．

\subsection{陰的 Euler 法}

\begin{table}[bp]
    \caption{陰的 Euler 法の Butcher 配列}
    \label{table:ode_runge-kutta_butcher-array-implicit-euler}
    \centering
    \begin{tabular}{c|c}
        $1$ & $1$ \\
        \hline
            & $1$
    \end{tabular}
\end{table}

常微分方程式の解法として，（陽的）Euler 法と同様に基本的な陰的 Euler 法も
形式的に Runge-Kutta 法とみなすことができる．
陰的 Euler 法は
\begin{equation}
    \bm{y}(t + h) \approx \bm{y}(t) + h \bm{f}(t, \bm{y}(t + h))
\end{equation}
のように書かれるが，
その Butcher 配列は表 \ref{table:ode_runge-kutta_butcher-array-implicit-euler} に示す通りである．
この 1 段 2 次公式は陰的公式とも半陰的公式ともとることができる．
